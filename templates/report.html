import collections
from typing import Dict, Deque

# 1. è§„èŒƒå¯¼å…¥
from astrbot.api.all import *
from astrbot.api.event import filter
from astrbot.api import logger

@register("astrbot_plugin_qq_group_summary_danfong", "GroupSummary", "ç¾¤èŠæ€»ç»“æ’ä»¶", "1.0.0")
class GroupSummaryPlugin(Star):
    def __init__(self, context: Context, config: dict):
        super().__init__(context)
        self.config = config
        
        # 2. è·å–é…ç½®ä¸­çš„é•¿æ–‡æœ¬æç¤ºè¯ (é»˜è®¤å€¼ä½œä¸ºå…œåº•)
        default_prompt = "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¾¤èŠæ€»ç»“åŠ©æ‰‹ã€‚è¯·æ ¹æ®ä»¥ä¸‹èŠå¤©è®°å½•ï¼Œæ€»ç»“å¤§å®¶çš„è®¨è®ºé‡ç‚¹ã€æœ‰è¶£çš„æ¢—ä»¥åŠæ´»è·ƒçš„è¯é¢˜ã€‚é£æ ¼è¦è½»æ¾å¹½é»˜ï¼Œé€‚å½“ä½¿ç”¨Emojiã€‚"
        self.summary_prompt = self.config.get("summary_prompt", default_prompt)
        
        # èŠå¤©è®°å½•ç¼“å­˜ï¼š{group_id: [msg1, msg2...]}ï¼Œæ¯ä¸ªç¾¤æœ€å¤šå­˜ 500 æ¡
        self.message_buffer: Dict[str, Deque[str]] = collections.defaultdict(lambda: collections.deque(maxlen=500))

    # ç›‘å¬ç¾¤æ¶ˆæ¯å¹¶è®°å½•
    @filter.event_message_type(filter.EventMessageType.GROUP_MESSAGE)
    async def on_message(self, event: AstrMessageEvent):
        if not event.message_obj.group_id:
            return
        
        group_id = str(event.message_obj.group_id)
        sender_name = event.message_obj.sender.nickname
        content = event.message_str
        
        # æ ¼å¼åŒ–è®°å½•: [å¼ ä¸‰]: å¤§å®¶å¥½
        record = f"[{sender_name}]: {content}"
        self.message_buffer[group_id].append(record)

    # 3. æ€»ç»“æŒ‡ä»¤
    @filter.command("æœ¬ç¾¤æ€»ç»“")
    async def manual_summary(self, event: AstrMessageEvent):
        group_id = str(event.message_obj.group_id)
        
        if group_id not in self.message_buffer or not self.message_buffer[group_id]:
            yield event.plain_result("ğŸš« æš‚æ— èŠå¤©è®°å½•ï¼Œè¯·å…ˆèŠå‡ å¥å§ï¼")
            return

        yield event.plain_result("â³ æ­£åœ¨æ ¹æ®æ‚¨è®¾å®šçš„ã€äººæ ¼é£æ ¼ã€‘ç”Ÿæˆæ€»ç»“ï¼Œè¯·ç¨å€™...")
        
        # è·å–æœ€è¿‘è®°å½•
        records = list(self.message_buffer[group_id])
        chat_history = "\n".join(records[-200:]) # å–æœ€è¿‘200æ¡é˜²æ­¢è¶…é•¿
        
        # 4. æ„å»ºå‘ç»™ LLM çš„ Prompt (æ ¸å¿ƒé€»è¾‘)
        # å°†é…ç½®çš„ã€äººæ ¼æç¤ºè¯ã€‘ä¸ã€èŠå¤©è®°å½•ã€‘æ‹¼æ¥
        final_prompt = (
            f"{self.summary_prompt}\n\n"
            f"---ä»¥ä¸‹æ˜¯èŠå¤©è®°å½•---\n"
            f"{chat_history}\n"
            f"---è®°å½•ç»“æŸ---\n"
            f"è¯·å¼€å§‹æ€»ç»“ï¼š"
        )

        # è°ƒç”¨ LLM
        try:
            # ä½¿ç”¨ AstrBot æä¾›çš„ LLM æ¥å£
            provider = self.context.conversation.provider
            if not provider:
                 yield event.plain_result("âŒ æœªé…ç½® LLM æ¨¡å‹ï¼Œæ— æ³•ç”Ÿæˆæ€»ç»“ã€‚")
                 return
                 
            response = await provider.text_chat(final_prompt, session_id=None)
            
            # å‘é€ç»“æœ
            yield event.plain_result(response.completion_text)
            
        except Exception as e:
            logger.error(f"æ€»ç»“ç”Ÿæˆå¤±è´¥: {e}")
            yield event.plain_result(f"âŒ ç”Ÿæˆå¤±è´¥: {e}")

    # ä¿®å¤äº†ä½ ä¹‹å‰æŠ¥é”™çš„å‡½æ•° (ç°åœ¨ä½œä¸ºç±»çš„æ–¹æ³•å­˜åœ¨ï¼Œç¼©è¿›æ­£ç¡®)
    async def generate_report(self, bot, group_id: str, silent: bool = False):
        # å¦‚æœéœ€è¦å®šæ—¶ä»»åŠ¡è°ƒç”¨ï¼Œå¯ä»¥åœ¨è¿™é‡Œå®ç°é€»è¾‘
        pass
